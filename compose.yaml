services:

  # *****************************************************************************
  # piwigo
  #   Piwigo is an open-source photo gallery platform designed for managing and 
  #   sharing digital images. It provides a user-friendly web interface with 
  #   features such as albums, tagging, metadata management, batch processing, 
  #   and access control. Piwigo is especially useful for organizing personal 
  #   collections, collaborative galleries, or professional photography archives. 
  #   When deployed in Docker, this service will run the Piwigo application, 
  #   connecting to its configured database backend (such as MySQL) 
  #   to store user accounts, gallery data, and configuration details. Combined 
  #   with reverse proxy solutions like NGINX Proxy Manager, it can be exposed 
  #   securely for external access.
  #
  # *****************************************************************************
  piwigo:
    image: linuxserver/piwigo:${TAG_PIWIGO:-latest}
    container_name: piwigo
    environment:
      - PUID=${PIWIGO_PUID:-1000}
      - PGID=${PIWIGO_PGID:-1000}
      - TZ=${TZ_ID}
    volumes:
      - config:/config
      - ${PIWIGO_GALLERIES_VOLUME}:/gallery
    ports:
      - ${PIWIGO_EXTERNAL_PORT:-8089}:80
    depends_on:
      - mysql
    restart: unless-stopped
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -------------
      - 'wud.tag.include=^\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://piwigo.org/changelogs'
      # Offen Backup Labels ---------------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *****************************************************************************
  # mysql
  #   MySQL is a widely used open-source relational database management system 
  #   known for its speed, stability, and ease of use. It serves as the backend 
  #   database engine for Piwigo, storing critical information such as user 
  #   accounts, photo metadata, album structures, tags, and configuration data. 
  #   By running MySQL in a dedicated service, Piwigo separates application logic 
  #   from persistent data storage, ensuring better performance, isolation, and 
  #   scalability. This setup also enables simplified backups, upgrades, and 
  #   maintenance of the galleryâ€™s data layer. When paired with a reverse proxy, 
  #   MySQL remains internal to the Docker network while securely powering Piwigo.
  #
  # *****************************************************************************
  mysql:
    image: mysql:${TAG_MYSQL:-latest}
    container_name: mysql-piwigo
    restart: always
    volumes:
      - mysql:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-piwigo}
      MYSQL_USER: ${MYSQL_USER:-piwigo}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    # -------------------------------------------------------------------------------
    # Uncomment this section to expose mysql to connections outside of the container
    # such as MySQL Workbench
    # -------------------------------------------------------------------------------
    # ports:
    #   - ${MYSQL_EXTERNAL_PORT:-3306}:3306
    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -------------
      - 'wud.tag.include=^8(\.\d+)*$$' # Show all version 8 updates
      # - 'wud.tag.include=^\d+\.\d+$' # Show all version updates
      - 'wud.link.template=https://dev.mysql.com/doc/relnotes/mysql/8.0/en/'
      # Offen Backup Labels ---------------------------------------------------------
      - "docker-volume-backup.stop-during-backup=${BACKUP_LABEL}"

  # *********************************************************************************
  # volume-backup
  #   Automated daily backup of Docker named volumes using offen/docker-volume-backup.
  #   This lightweight service runs in the background, creates a single compressed 
  #   archive containing all specified volumes, and automatically prunes old backups 
  #   based on the configured retention period. It ensures data consistency by 
  #   temporarily stopping labeled containers during the backup process. Backups 
  #   are stored locally on the host; a separate secure process (e.g., rsync/cron) 
  #   can be used for off-site transfer.
  #
  # *********************************************************************************
  volume-backup:
    image: offen/docker-volume-backup:${TAG_OFFEN:-latest}
    container_name: ${BACKUP_LABEL}-backup
    restart: unless-stopped
    depends_on:
      - piwigo
      - mysql
    environment:
      - TZ=${TZ_ID:-America/New_York}
      - BACKUP_CRON_EXPRESSION=${BACKUP_CRON_EXPRESSION:-0 2 * * *}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-14}
      - BACKUP_FILENAME=${BACKUP_LABEL}-%Y-%m-%dT%H-%M-%S.tar.gz
      - BACKUP_STOP_DURING_BACKUP_LABEL=${BACKUP_LABEL}
      - NOTIFICATION_LEVEL=${BACKUP_NOTIFICATION_LEVEL:-error}
      - NOTIFICATION_URLS=${BACKUP_NOTIFICATION_URLS}          # Comma-separated list of URLs      
    volumes:
      # Volumes to backup
      - mysql:/backup/mysql:ro                     
      - config:/backup/config:ro                   
      # Local backup location - use a separate secure transfer process to move backups to another host
      - ${BACKUP_LOCAL_TMP_PATH}:/tmp  # Assign a specific tmp dir on the host.  Comment this out to use /tmp
      - ${BACKUP_LOCAL_PATH}:/archive                     
      # Time synch with host to ensure accurate CRON scheduling
      - /etc/localtime:/etc/localtime:ro               
      - /etc/timezone:/etc/timezone:ro                 
      # Allows backup container to control other containers
      - /var/run/docker.sock:/var/run/docker.sock:ro   

    labels:
      # WUD - What's up docker labels (https://getwud.github.io/wud/#/) -------------
      # Support leading 'V'
      - 'wud.tag.include=^v\d+\.\d+\.\d+$$'
      - 'wud.link.template=https://github.com/offen/docker-volume-backup/releases' 

volumes:
  config:
  mysql:

